# デプロイガイド

このガイドでは、AWS DMSを使用したAurora MySQL間のレプリケーション環境を構築する手順を詳しく説明します。AWS コマンドに詳しくない方でも簡単に環境を構築できるよう、`run.sh` スクリプトを使用した手順を紹介します。

## 前提条件

- AWS CLIがインストールされていること
- AWS認証情報が設定されていること
- CloudFormationスタックを作成するための適切なIAM権限があること
- SSMセッションマネージャーを使用するための権限があること
- MySQLクライアントがインストールされていること（ローカルからデータベースに接続するため）

## デプロイ手順

### ステップ1: 基本的なAurora MySQL環境をデプロイ

まず、2つのAurora MySQLクラスターと踏み台サーバーを含む基本的な環境をデプロイします。

```bash
./run.sh deploy --db-password YourStrongPassword
```

このコマンドは以下のリソースをデプロイします：
- VPCとサブネット
- 2つのAurora MySQLクラスター（マスターDBとセカンドDB）
- 踏み台サーバー用のEC2インスタンス
- 必要なセキュリティグループとIAMロール

デプロイには約15〜20分かかります。デプロイの進行状況は以下のコマンドで確認できます：

```bash
./run.sh status
```

### ステップ2: サンプルデータベースファイルの準備

サンプルデータベースをインポートする前に、必要なファイルを準備します。以下のコマンドを実行して、サンプルデータファイルを自動的に準備します：

```bash
./run.sh prepare-sample-data
```

このコマンドは以下の処理を行います：
- `resources/samples` ディレクトリにある圧縮ファイルを検出
- `world-db.zip` から `world.sql` ファイルを抽出

必要なファイルが見つからない場合は、以下の手順で手動でダウンロードしてください：

1. World データベース:
   - [MySQL公式サイト](https://dev.mysql.com/doc/index-other.html)から「world database」をダウンロード
   - ダウンロードしたファイルを `resources/samples/world-db.zip` として保存
   - または、解凍済みの `world.sql` ファイルを `resources/samples/world.sql` として直接配置

ファイルを配置した後、再度 `./run.sh prepare-sample-data` を実行すると、必要なSQLファイルが自動的に作成されます。

### ステップ3: ポートフォワーディングの設定

データベースにローカルから接続するために、2つのターミナルウィンドウを開き、それぞれでポートフォワーディングを設定します：

ターミナル1（マスターDB用）:
```bash
./run.sh port-forward-master --local-port 13306
```

ターミナル2（セカンドDB用）:
```bash
./run.sh port-forward-second --local-port 13307
```

これらのコマンドは、SSMセッションマネージャーを使用して踏み台サーバーに接続し、ポートフォワーディングを設定します。コマンドは実行したままにしておいてください。

### ステップ4: サンプルデータベースをインポート

ポートフォワーディングを設定したら、3つ目のターミナルウィンドウで以下のコマンドを実行してサンプルデータベースをインポートします：

```bash
./run.sh import-sample-db --master-port 13306 --second-port 13307
```

このコマンドは以下の処理を行います：
- ポートフォワーディングが正常に機能しているか確認
- `resources/samples` ディレクトリにある `world.sql` ファイルを使用
- セカンドDBに以下のデータベースをインポート：
  - `world` データベース（レプリケーション対象）
  - `worldnonrepl` データベース（レプリケーション非対象）
- マスターDBに空の `world` データベースを作成（レプリケーションのターゲット）

データベースのユーザー名とパスワードの入力を求められます。デプロイ時に指定したパスワードを入力してください。

### ステップ5: DMSレプリケーションをデプロイ

サンプルデータベースのインポートが完了したら、DMSレプリケーションをデプロイします。

```bash
./run.sh deploy-dms --db-password YourStrongPassword
```

このコマンドは以下のリソースをデプロイします：
- DMSレプリケーションインスタンス
- DMSソースエンドポイント（セカンドDBを指す）
- DMSターゲットエンドポイント（マスターDBを指す）
- DMSレプリケーションタスク（デフォルトで `world` データベースをレプリケーション対象に設定）
- 必要なIAMロールとセキュリティグループ

デプロイには約10〜15分かかります。デプロイの進行状況は以下のコマンドで確認できます：

```bash
./run.sh status-dms
```

### ステップ6: レプリケーションを検証

DMSレプリケーションのデプロイが完了したら、レプリケーションが正常に機能しているかを検証します。

```bash
./run.sh verify-replication --master-port 13306 --second-port 13307
```

このコマンドは以下の検証を行います：
- ポートフォワーディングが正常に機能しているか確認
- `world` データベースがレプリケーションされているか確認
- `worldnonrepl` データベースがレプリケーションされていないか確認
- 継続的なレプリケーションをテスト（新しい行を挿入して複製されるか確認）

データベースのユーザー名とパスワードの入力を求められます。デプロイ時に指定したパスワードを入力してください。

### ステップ7: DMSタスクの管理

DMSタスクを管理するには、以下のコマンドを使用します：

```bash
# タスクのステータスを確認
./run.sh status-dms

# タスクを停止
./run.sh stop-dms

# タスクを開始
./run.sh start-dms

# タスクを再起動
./run.sh restart-dms
```

## トラブルシューティング

### 一般的な問題

1. **ポートフォワーディングの問題**: ローカルからデータベースに接続できない場合は、ポートフォワーディングが正常に設定されていることを確認してください。`./run.sh port-forward-master` と `./run.sh port-forward-second` コマンドが実行中であることを確認します。

2. **サンプルデータファイルの問題**: サンプルデータファイルが見つからない場合は、`./run.sh prepare-sample-data` コマンドを実行して自動的に準備するか、手動で必要なファイルを `resources/samples` ディレクトリに配置してください。

3. **レプリケーションエラー**: DMSタスクのステータスとログを確認してください。`./run.sh status-dms` コマンドを使用して詳細を確認できます。

4. **接続エラー**: EC2インスタンスがRDSエンドポイントに到達できることを確認してください。セキュリティグループの設定を確認します。

5. **権限エラー**: AWS CLIの認証情報と、SSMセッションマネージャーを使用するための適切なIAM権限があることを確認してください。

6. **レプリケーション対象の確認**: デフォルトでは `world` データベースのみがレプリケーション対象として設定されています。別のデータベースをレプリケーションする場合は、`--source-db` オプションを使用してください。例: `./run.sh deploy-dms --db-password YourStrongPassword --source-db other_database`

## クリーンアップ

環境を削除するには、以下の手順でスタックを削除します：

```bash
# 1. DMSレプリケーションスタックを削除
./run.sh delete-dms

# 2. Aurora MySQL環境スタックを削除
./run.sh delete
```

スタックの削除には約10〜15分かかります。