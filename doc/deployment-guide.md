# デプロイガイド

このガイドでは、AWS DMSを使用したAurora MySQL間のレプリケーション環境を構築する手順を詳しく説明します。AWS コマンドに詳しくない方でも簡単に環境を構築できるよう、`run.sh` スクリプトを使用した手順を紹介します。

## 前提条件

- AWS CLIがインストールされていること
- AWS認証情報が設定されていること
- CloudFormationスタックを作成するための適切なIAM権限があること
- SSMセッションマネージャーを使用するための権限があること
- ローカルからデータベースをインポートする場合は、MySQLクライアントがインストールされていること

## デプロイ手順

### ステップ1: 基本的なAurora MySQL環境をデプロイ

まず、2つのAurora MySQLクラスターと踏み台サーバーを含む基本的な環境をデプロイします。

```bash
./run.sh deploy --db-password YourStrongPassword
```

このコマンドは以下のリソースをデプロイします：
- VPCとサブネット
- 2つのAurora MySQLクラスター（マスターDBとセカンドDB）
- 踏み台サーバー用のEC2インスタンス
- 必要なセキュリティグループとIAMロール

デプロイには約15〜20分かかります。デプロイの進行状況は以下のコマンドで確認できます：

```bash
./run.sh status
```

### ステップ2: サンプルデータベースファイルの準備

サンプルデータベースをインポートする前に、必要なファイルを手動でダウンロードして配置する必要があります。

1. `resources/samples` ディレクトリを作成します：

```bash
mkdir -p resources/samples
```

2. 以下のサンプルデータベースファイルをダウンロードして `resources/samples` ディレクトリに配置します：

   - World データベース:
     - [MySQL公式サイト](https://dev.mysql.com/doc/index-other.html)から「world database」をダウンロード
     - ダウンロードしたファイルを解凍し、`world.sql` として保存

   - Employees データベース:
     - [GitHub リポジトリ](https://github.com/datacharmer/test_db)からダウンロード
     - リポジトリをクローンまたはZIPファイルとしてダウンロード
     - 必要なファイルを結合して `employees.sql` として保存

   または、他の信頼できるソースからこれらのサンプルデータベースファイルを入手して配置することもできます。

### ステップ3: サンプルデータベースをインポート

サンプルデータベースファイルを配置したら、以下の手順に従ってインポートします：

1. 2つのターミナルウィンドウを開き、それぞれでポートフォワーディングを設定します：

ターミナル1（マスターDB用）:
```bash
./run.sh port-forward-master --local-port 13306
```

ターミナル2（セカンドDB用）:
```bash
./run.sh port-forward-second --local-port 13307
```

2. 3つ目のターミナルウィンドウで、以下のコマンドを実行してサンプルデータベースをインポートします：

```bash
./run.sh import-sample-db --master-port 13306 --second-port 13307
```

このコマンドは、ポートフォワーディングを使用してローカルからデータベースに接続し、サンプルデータベースをインポートします。

このスクリプトは以下の処理を行います：
- `resources/samples` ディレクトリにある `world.sql` と `employees.sql` ファイルを使用
- セカンドDBにこれらのデータベースをインポート
- マスターDBに空のWorldデータベースを作成

### ステップ4: DMSレプリケーションをデプロイ

サンプルデータベースのインポートが完了したら、DMSレプリケーションをデプロイします。

```bash
./run.sh deploy-dms --db-password YourStrongPassword --source-db world
```

このコマンドは以下のリソースをデプロイします：
- DMSレプリケーションインスタンス
- DMSソースエンドポイント（セカンドDBを指す）
- DMSターゲットエンドポイント（マスターDBを指す）
- DMSレプリケーションタスク
- 必要なIAMロールとセキュリティグループ

デプロイには約10〜15分かかります。デプロイの進行状況は以下のコマンドで確認できます：

```bash
./run.sh status-dms
```

### ステップ5: レプリケーションを検証

DMSレプリケーションのデプロイが完了したら、レプリケーションが正常に機能しているかを検証します。

1. 踏み台サーバーに接続：

```bash
./run.sh connect-ec2
```

2. レプリケーションを検証：

```bash
chmod +x scripts/verify_replication.sh
./scripts/verify_replication.sh rds-replication-stack
```

このスクリプトは以下の検証を行います：
- ソースとターゲットのデータベース間でテーブル数を比較
- 各テーブルの行数を比較
- 新しい行を挿入して継続的なレプリケーションをテスト

### ステップ6: DMSタスクの管理

DMSタスクを管理するには、以下のコマンドを使用します：

```bash
# タスクのステータスを確認
./run.sh status-dms

# タスクを停止
./run.sh stop-dms

# タスクを開始
./run.sh start-dms

# タスクを再起動
./run.sh restart-dms
```

## トラブルシューティング

### 一般的な問題

1. **接続エラー**: EC2インスタンスがRDSエンドポイントに到達できることを確認してください。セキュリティグループの設定を確認します。

2. **権限エラー**: AWS CLIの認証情報と、SSMセッションマネージャーを使用するための適切なIAM権限があることを確認してください。

3. **レプリケーションエラー**: DMSタスクのステータスとログを確認してください。バイナリログが有効になっていることを確認します。

4. **ポートフォワーディングの問題**: ローカルからデータベースに接続できない場合は、ポートフォワーディングが正常に設定されていることを確認してください。また、ローカルのMySQLクライアントが正しくインストールされていることを確認します。

5. **サンプルデータベースファイルの問題**: サンプルデータベースファイルが見つからない場合は、正しい場所に配置されていることを確認してください。ファイルの形式が正しいことも確認します。

### DMSタスクのログ確認

DMSタスクのログを確認するには、以下のコマンドを使用します：

```bash
./run.sh status-dms
```

このコマンドはDMSレプリケーションタスクのステータスと統計情報を表示します。

## クリーンアップ

環境を削除するには、以下の手順でスタックを削除します：

```bash
# 1. DMSレプリケーションスタックを削除
aws cloudformation delete-stack --stack-name dms-replication

# 2. Aurora MySQL環境スタックを削除
./run.sh delete
```

スタックの削除には約10〜15分かかります。